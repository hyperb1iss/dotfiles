- defaults:
    link:
      relink: true

- clean: ["~"]

- link:
    /lib/udev/rules.d/60-android.rules: rules.d/60-android.rules
    /etc/sysctl.d/50-inotify.conf: sysctl.d/50-inotify.conf

- shell:
    - command: |
        if command -v pacman >/dev/null 2>&1; then
          # Arch Linux setup
          sudo pacman -Syu --noconfirm
          # Install packages from list (failures will be non-fatal)
          grep -v '^#\|^$' packages_arch.txt | xargs -r sudo pacman -S --needed --noconfirm || true
        else
          # Ubuntu/Debian setup
          sudo add-apt-repository -y ppa:longsleep/golang-backports
          sudo add-apt-repository -y ppa:git-core/ppa
          sudo add-apt-repository -y ppa:zhangsongcui3371/fastfetch
          sudo apt update
          grep -v '^#\|^$' packages.txt | xargs sudo apt install -y
          # Install stable Rust toolchain via rustup (never use apt's cargo/rustc)
          if command -v rustup >/dev/null 2>&1; then
            echo "Installing Rust stable toolchain..."
            rustup toolchain install stable
            # Source cargo env AND install tools in same subshell so PATH persists
            if [ -f "$HOME/.cargo/env" ]; then
              source "$HOME/.cargo/env"
              echo "ðŸ“¦ Installing Rust CLI tools..."
              grep -v '^#\|^$' cargo-tools.txt | sed 's/#.*//' | xargs cargo install
            fi
          fi

          # Install Docker Engine from official apt repository
          if ! command -v docker >/dev/null 2>&1; then
            echo "ðŸ³ Installing Docker Engine..."
            # Remove conflicting packages
            sudo apt remove -y docker.io docker-compose docker-compose-v2 docker-doc podman-docker containerd runc 2>/dev/null || true
            # Add Docker's official GPG key
            sudo install -m 0755 -d /etc/apt/keyrings
            sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
            sudo chmod a+r /etc/apt/keyrings/docker.asc
            # Add the repository to apt sources
            CODENAME=$(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}")
            printf '%s\n' "Types: deb" "URIs: https://download.docker.com/linux/ubuntu" "Suites: $CODENAME" "Components: stable" "Signed-By: /etc/apt/keyrings/docker.asc" | sudo tee /etc/apt/sources.list.d/docker.sources
            sudo apt update
            sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
            # Add current user to docker group for non-root access
            sudo usermod -aG docker "$USER"
            echo "âœ… Docker installed. Log out and back in for group changes to take effect."
          fi
        fi
      stderr: true
      stdout: true
    - command: |
        if command -v update-alternatives >/dev/null 2>&1; then
          sudo update-alternatives --install /usr/bin/editor editor /usr/bin/nvim 60
          sudo update-alternatives --install /usr/bin/vim vim /usr/bin/nvim 60
        fi
      stderr: true
      stdout: true
    - command: |
        # Install kind for Kubernetes local clusters (not available in official repos)
        if command -v pacman >/dev/null 2>&1 && ! command -v kind >/dev/null 2>&1; then
          echo "Installing kind from GitHub releases..."
          KIND_VERSION="v0.25.0"
          curl -Lo ./kind "https://kind.sigs.k8s.io/dl/${KIND_VERSION}/kind-linux-amd64"
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
          echo "kind installed successfully"
        fi
      stderr: true
      stdout: true

- shell:
    - mkdir -p ~/.config/fastfetch
- link:
    ~/.config/fastfetch/config.jsonc: fastfetch/config.jsonc
