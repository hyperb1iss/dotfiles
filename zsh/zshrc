# Zsh-specific settings and configurations

# History settings
setopt share_history
setopt hist_ignore_all_dups
setopt inc_append_history
setopt EXTENDED_HISTORY

# Shell compatibility options
setopt SH_WORD_SPLIT        # Enable bash-style word splitting
setopt EXTENDED_GLOB        # Enable extended globbing
setopt INTERACTIVE_COMMENTS # Enable bash-style comments

# Navigation magic
setopt AUTO_CD              # Type directory name to cd into it
setopt AUTO_PUSHD           # cd pushes old dir to stack
setopt PUSHD_IGNORE_DUPS    # No duplicates in dir stack
setopt PUSHD_SILENT         # Don't print stack after pushd

HISTSIZE=50000
# Export SAVEHIST so shellcheck knows it's used by zsh internally
export SAVEHIST=50000
HISTFILE=~/.zsh_history

# Source custom configurations
source ~/dev/dotfiles/zsh/completion.zsh

# ZINIT - Zsh Plugin Manager
ZINIT_HOME="${XDG_DATA_HOME:-${HOME}/.local/share}/zinit/zinit.git"
if [[ ! -d "${ZINIT_HOME}" ]]; then
  mkdir -p "$(dirname "${ZINIT_HOME}")"
  git clone https://github.com/zdharma-continuum/zinit.git "${ZINIT_HOME}"
fi
source "${ZINIT_HOME}/zinit.zsh"

# Source critical environment and common functions BEFORE Zinit plugins
# This ensures PATH is set for plugins (like Starship) and helpers are available.
source "${HOME}/dev/dotfiles/sh/shell-common.sh" # Source this first for helper functions
source "${HOME}/dev/dotfiles/sh/env.sh"          # Then source env for PATH and other vars
source "${HOME}/dev/dotfiles/sh/terminal.sh"     # Source terminal title management

# Set initial terminal title for interactive, non-minimal Zsh sessions
if is_zsh && [[ $- == *i* ]] && ! is_minimal; then
  set_terminal_title
fi

# Load plugins with Zinit
# Using 'light' for faster loading without reporting/investigation
zinit light zsh-users/zsh-autosuggestions
zinit light zsh-users/zsh-syntax-highlighting
zinit light zsh-users/zsh-history-substring-search
zinit light Aloxaf/fzf-tab

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Atuin: Modern shell history with per-directory awareness
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Atuin replaces Ctrl+R with a full-screen fuzzy search UI
# Features: SQLite backend, directory filtering, cross-machine sync, stats
if command -v atuin &>/dev/null; then
  eval "$(atuin init zsh)"

  # Custom strategy for zsh-autosuggestions using Atuin's per-directory history
  _zsh_autosuggest_strategy_atuin() {
    suggestion=$(atuin search --cmd-only --limit 1 --search-mode prefix -- "$1" 2>/dev/null)
  }
  # Use Atuin first, fall back to standard history if no match
  ZSH_AUTOSUGGEST_STRATEGY=(atuin history completion)
fi

# Note: Up/down arrows handled by Atuin with workspace filtering
# history-substring-search still available via Ctrl+P/Ctrl+N if needed
bindkey '^P' history-substring-search-up
bindkey '^N' history-substring-search-down

# Initialize Starship prompt
zinit ice atload"eval \"\$(starship init zsh)\""
zinit light starship/starship

# Add other plugins here, e.g.:
# zinit light zdharma-continuum/fast-syntax-highlighting # Alternative syntax highlighting
# zinit light romkatv/powerlevel10k # If you want Zinit to manage P10k

# Source shell-common.sh directly to make its functions globally available
# before Zinit compiles other snippets that depend on them.

# Load our own shell scripts using Zinit
# Loop through sh/*.sh files and load them as snippets, excluding common/env.
for script_file in "${HOME}/dev/dotfiles/sh/"*.sh; do
  script_basename=$(basename "${script_file}")
  if [[ "${script_basename}" == "shell-common.sh" ||
    "${script_basename}" == "env.sh" ||
    "${script_basename}" == "terminal.sh" ]]; then
    continue # Skip common, env, and terminal scripts as they are sourced directly
  fi
  zinit ice lucid wait"0"
  zinit snippet "${script_file}"
done

# Command not found handler
if [[ -f /usr/share/doc/pkgfile/command-not-found.zsh ]]; then
  source /usr/share/doc/pkgfile/command-not-found.zsh
elif [[ -f /etc/zsh_command_not_found ]]; then
  source /etc/zsh_command_not_found
fi

# Development alias for clearing Zinit cache and reloading shell
alias zzz='zinit update'

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Zsh Power Features
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# zmv — batch renaming: zmv '(*).txt' '$1.md'
autoload -Uz zmv

# Edit current command in $EDITOR (Ctrl+X, Ctrl+E)
autoload -Uz edit-command-line
zle -N edit-command-line
bindkey '^x^e' edit-command-line

# Named directories — teleportation shortcuts
# Usage: cd ~dots, vim ~cfg/ghostty/config
hash -d dots=~/dev/dotfiles
hash -d cfg=~/.config
hash -d dev=~/dev

# Global aliases — expand anywhere in pipeline
alias -g G='| grep'
alias -g L='| less'
alias -g J='| jq .'
alias -g NE='2>/dev/null'

# Suffix aliases — open files by extension
alias -s md='code'
alias -s json='jq .'
alias -s git='git clone'

# pnpm
if [[ "$OSTYPE" == "darwin"* ]]; then
  export PNPM_HOME="$HOME/Library/pnpm"
else
  export PNPM_HOME="$HOME/.local/share/pnpm"
fi
case ":$PATH:" in
  *":$PNPM_HOME:"*) ;;
  *) export PATH="$PNPM_HOME:$PATH" ;;
esac
# pnpm end
safe_source "${HOME}/.ghcup/env"
